#!/usr/bin/env ruby
# frozen_string_literal: true

require "yaml"
require_relative "../lib/dokku/logger"

class DokkuProcfileGenerator
  def self.call(compose_file_path, output_path = "Procfile")
    logger = Dokku::Logger.new(STDOUT)

    compose_config = YAML.load(File.read(compose_file_path))

    procfile_hash = compose_config.dig("x-dokku", "procfile") || {}

    compose_config["services"].each do |service_name, service_config|
      procfile_hash[service_name] = service_config["command"]
    end

    procfile_contents = procfile_hash.compact.map { |k, v| "#{k}: #{v}" }

    if procfile_contents.empty?
      logger.info "No usable Procfile built from #{compose_file_path}, skipping..."
    else
      File.write(output_path, procfile_contents.join("\n"))
    end
  end
end

DokkuProcfileGenerator.call(*ARGV)