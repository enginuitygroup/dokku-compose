#!/usr/bin/env ruby
# frozen_string_literal: true

require "yaml"
require "json"
require_relative "../lib/dokku/logger"

class DokkuAppJsonGenerator
  def self.call(...)
    new.call(...)
  end

  def call(compose_file_path, output_path = "app.json")
    compose_config = YAML.load(File.read(compose_file_path))

    app_json_contents = compose_config.dig("x-dokku", "app-json") || {}

    app_json_contents = compose_config["services"].inject(app_json_contents) do |memo, (service_name, service_config)|
      memo = configure_healthchecks(memo, service_name, service_config)
      configure_formation(memo, service_name, service_config)
    end

    if app_json_contents.empty?
      logger.info "No usable app.json built from #{compose_file_path}, skipping..."
    else
      File.write(output_path, JSON.dump(app_json_contents))
    end
    
  end

  private def configure_healthchecks(app_json, service_name, service_config)
    return app_json unless service_config.key?("healthcheck")
    
    logger.debug "Configuring healthchecks for #{service_name}"

    app_json[:healthchecks] ||= {}

    app_json_service_config = {
      type:         service_config.dig("healthcheck", "x-dokku", "type") || "startup",
      command:      service_config.dig("healthcheck", "test"),
      attempts:     service_config.dig("healthcheck", "retries"),
      initialDelay: service_config.dig("healthcheck", "interval"),
      timeout:      service_config.dig("healthcheck", "timeout"),
      wait:         service_config.dig("healthcheck", "interval"),
      httpHeaders:  service_config.dig("healthcheck", "x-dokku", "http-headers"),
      path:         service_config.dig("healthcheck", "x-dokku", "path"),
      port:         service_config.dig("healthcheck", "x-dokku", "port"),
      scheme:       service_config.dig("healthcheck", "x-dokku", "scheme")
    }.compact

    app_json.merge(healthchecks: app_json[:healthchecks].merge(service_name => app_json_service_config))
  end

  private def configure_formation(app_json, service_name, service_config)
    return app_json unless service_config.key?("deploy")

    logger.debug "Configuration formation for #{service_name}"

    app_json[:formation] ||= {}
    
    app_json_service_config = {
      quantity:     service_config.dig("deploy", "replicas"),
      max_parallel: service_config.dig("deploy", "update_config", "parallelism")
    }.compact

    app_json.merge(formation: app_json[:formation].merge(service_name => app_json_service_config))
  end

  private def logger = @logger ||= Dokku::Logger.new(STDOUT)
end

DokkuAppJsonGenerator.call(*ARGV)