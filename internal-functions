#!/usr/bin/env bash
source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
source "$PLUGIN_CORE_AVAILABLE_PATH/common/property-functions"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

fn-find-compose-path() {
  declare APP="$1"
  COMMON_COMPOSE_PATHS="docker-compose.yml docker-compose.yaml compose.yml compose.yaml"
  GLOBAL_COMPOSE_PATH=$(fn-plugin-property-get "compose" "--global" "compose-path")
  COMPOSE_PATH=$(fn-plugin-property-get "compose" "$APP" "compose-path")

  if [[ "$COMPOSE_PATH" != "" ]]; then
    echo $COMPOSE_PATH
    exit 0
  fi

  if [[ "$GLOBAL_COMPOSE_PATH" != "" ]]; then
    echo $GLOBAL_COMPOSE_PATH
    exit 0
  fi

  for compose_path in $COMMON_COMPOSE_PATHS; do
    if [[ -f "$compose_path" ]]; then
      echo $compose_path
      exit 0
    fi
  done

  dokku_log_info1_quiet "No compose file found; no app.json or Procfile will be generated"
}

fn-compose-from-image() {
  declare WORK_DIR="$1" SOURCE_IMAGE="$2" COMPOSE_PATH="$3"
  WORK_COMPOSE_PATH=$WORK_DIR/$COMPOSE_PATH

  [[ -f "$WORK_COMPOSE_PATH" ]] || mkdir -p $(dirname $WORK_COMPOSE_PATH)

  "$DOCKER_BIN" run --rm "$SOURCE_IMAGE" cat "$COMPOSE_PATH" > "$WORK_COMPOSE_PATH"
  
  fn-compose-from-repo "$WORK_DIR" "$WORK_COMPOSE_PATH"

  # TODO: What if there's already an app.json and Procfile in the image?

  # If we generated an app.json file, add a line to the Dockerfile generated by git:from-image
  if [[ -f "$WORK_DIR/app.json" ]]; then
    echo "COPY app.json ." >> "$WORK_DIR/Dockerfile"
    fn-plugin-property-write "compose" "$APP" "app-json" "true"
  else
    fn-plugin-property-delete "compose" "$APP" "app-json"
  fi

  # If we generated a Procfile, add a line to the Dockerfile generated by git:from-image
  if [[ -f "$WORK_DIR/Procfile" ]]; then
    echo "COPY Procfile ." >> "$WORK_DIR/Dockerfile"
    fn-plugin-property-write "compose" "$APP" "procfile" "true"
  else
    fn-plugin-property-delete "compose" "$APP" "procfile"
  fi

  exit 0
}

fn-compose-from-repo() {
  declare WORK_DIR="$1" WORK_COMPOSE_PATH="$2"

  dokku_log_info1_quiet "[compose] Generating app.json"
  "$PLUGIN_AVAILABLE_PATH/compose/bin/app-json-from-compose" "$WORK_COMPOSE_PATH" "$WORK_DIR/app.json"

  dokku_log_info1_quiet "[compose] Generating Procfile"
  "$PLUGIN_AVAILABLE_PATH/compose/bin/procfile-from-compose" "$WORK_COMPOSE_PATH" "$WORK_DIR/Procfile"
}

fn-compose-set-resources() {
  declare APP="$1" IMAGE="$2" COMPOSE_PATH="$3"
  TMP_COMPOSE_PATH="/tmp/$APP-compose.yml"

  "$DOCKER_BIN" run --rm "$IMAGE" cat "$COMPOSE_PATH" > "$TMP_COMPOSE_PATH"

  "$PLUGIN_AVAILABLE_PATH/compose/bin/set-resources-from-compose" "$APP" "$TMP_COMPOSE_PATH"
}